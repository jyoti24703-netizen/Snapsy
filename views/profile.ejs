<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/profile.css">
  </head>
  <body>

    <!-- ðŸ”¹ Top bar with Feed button -->
    <div class="container mt-3 d-flex justify-content-end">
      <a href="/feed" class="btn btn-danger btn-sm">Feed</a>
    </div>

    <div class="containerpers">
      <div class="cardpers text-center">
        <div class="profile-picture mb-3">
          <img src="https://images.unsplash.com/photo-1756811954479-82f0c0c27c53?w=600" 
               alt="Profile Picture" class="rounded-circle" width="120">
        </div>
        <h2 class="name"><%= user.fullname %></h2>
        <h3 class="username">@<%= user.username %></h3>

        <!-- âœ… Replaced placeholder text -->
        <p class="tagline">Sharing moments, one post at a time.</p>
        <p class="description">Welcome to your profile! Upload your thoughts, photos, and videos to express yourself.</p>
        
        <!-- ðŸ”¹ Logout button red -->
        <a href="/logout" class="btn btn-danger mb-3">Logout</a>

        <!-- âœ… Upload form in one line -->
        <form action="/upload" method="post" enctype="multipart/form-data" class="d-flex gap-2 mt-3 justify-content-center">
          <input type="text" name="filecaption" placeholder="Some caption"
                 class="form-control" style="max-width: 200px;">
          <input type="file" name="file" class="form-control" style="max-width: 250px;">
          <button type="submit" class="btn btn-danger">Submit</button>
        </form>
      </div>
    </div>

    <!-- âœ… Posts -->
    <div class="container mt-4">
      <div class="row g-3">
        <% user.posts.forEach(function(post){ %>
          <div class="col-md-4">
            <div class="card">
              <% if (post.image) { %>
                <img src="/images/uploads/<%= post.image %>" 
                     class="card-img-top open-media"
                     data-bs-toggle="modal" 
                     data-bs-target="#mediaModal" 
                     data-type="image" 
                     data-src="/images/uploads/<%= post.image %>">
              <% } else if (post.video) { %>
                <!-- âœ… Video with play icon -->
                <div class="video-wrapper position-relative">
                  <video width="100%" class="open-media" 
                         data-bs-toggle="modal" 
                         data-bs-target="#mediaModal" 
                         data-type="video" 
                         data-src="/images/uploads/<%= post.video %>" 
                         preload="metadata" 
                         muted>
                    <source src="/images/uploads/<%= post.video %>#t=0.1" type="video/mp4">
                  </video>
                  <span class="play-icon">&#9658;</span>
                </div>
              <% } %>
              <div class="card-body">
                <h5 class="card-title"><%= post.imageText %></h5>

                <!-- Delete + Edit -->
                <form action="/delete/<%= post._id %>" method="post" class="d-inline">
                  <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
                <a href="/edit/<%= post._id %>" class="btn btn-primary btn-sm">Edit</a>

                <!-- Comment input -->
                <input type="text" class="form-control mt-2 comment-input" 
                       data-postid="<%= post._id %>" placeholder="Write a comment...">

                <!-- Comments list -->
                <ul class="list-group list-group-flush mt-2 comments-list" id="comments-<%= post._id %>">
                </ul>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- âœ… Modal for opening posts -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-body text-center">
            <!-- content gets injected by JS -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // âœ… Modal handler for opening posts
      const modal = document.getElementById('mediaModal');
      const modalBody = modal.querySelector('.modal-body');

      document.querySelectorAll('.open-media').forEach(el => {
        el.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          const src = this.getAttribute('data-src');

          if(type === 'image') {
            modalBody.innerHTML = '<img src="'+src+'" class="img-fluid rounded">';
          } else if(type === 'video') {
            modalBody.innerHTML = `
              <video controls autoplay muted playsinline style="width:100%">
                <source src="${src}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            `;
          }
        });
      });

      modal.addEventListener('hidden.bs.modal', () => {
        modalBody.innerHTML = '';
      });

      // âœ… Comment AJAX
      document.querySelectorAll('.comment-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const postId = this.getAttribute('data-postid');
            const text = this.value.trim();
            if (!text) return;

            fetch('/comment/' + postId, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const list = document.getElementById('comments-' + postId);
                const li = document.createElement('li');
                li.className = "list-group-item";
                li.textContent = data.comment.user + ": " + data.comment.text;
                list.prepend(li);
                this.value = "";
              } else {
                alert("Error adding comment");
              }
            });
          }
        });
      });
    </script>
  </body>
</html>
